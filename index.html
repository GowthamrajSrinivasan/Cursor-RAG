<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Interface</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for chat messages */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #e2e8f0; /* light gray */
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-600 */
        }
        /* Custom scrollbar for logs */
        .query-logs-content::-webkit-scrollbar {
            width: 8px;
        }
        .query-logs-content::-webkit-scrollbar-track {
            background: #e2e8f0; /* light gray */
            border-radius: 10px;
        }
        .query-logs-content::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        .query-logs-content::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-600 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">AI Agent Chat</h1>
            <div id="connectionStatus" class="text-sm">
                <span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-1"></span> Connected
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto p-6 grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- Chat Interface (Left 2/3 on desktop) -->
        <section class="md:col-span-2 bg-white rounded-lg shadow-xl flex flex-col h-full">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">Conversation</h2>
            </div>
            <div id="chatMessages" class="chat-messages flex-grow p-4 overflow-y-auto space-y-4">
                <!-- Chat messages will be appended here -->
                <div class="flex justify-start">
                    <div class="bg-blue-100 text-blue-800 p-3 rounded-lg max-w-xs md:max-w-md shadow">
                        Hello! How can I assist you with the knowledge base today?
                    </div>
                </div>
            </div>
            <div id="toolUsageIndicator" class="p-2 text-sm text-gray-600 italic border-t border-gray-200 hidden">
                <span class="flex items-center">
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Agent is <span id="currentToolName">thinking</span>...
                </span>
            </div>
            <form id="queryForm" class="p-4 border-t border-gray-200 flex space-x-2">
                <input type="text" id="queryInput" placeholder="Ask your question here..."
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       required autocomplete="off">
                <button type="submit"
                        class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Send
                </button>
            </form>
        </section>

        <!-- Sidebar (Right 1/3 on desktop) -->
        <aside class="md:col-span-1 flex flex-col space-y-6">

            <!-- Statistics Panel -->
            <div class="bg-white rounded-lg shadow-xl p-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Agent Statistics</h2>
                <div class="space-y-2 text-gray-700">
                    <p><strong>Total Queries:</strong> <span id="totalQueries" class="font-medium">0</span></p>
                    <p><strong>Last Query Time:</strong> <span id="lastQueryTime" class="font-medium">N/A</span></p>
                </div>
            </div>

            <!-- Query Logs Toggle & Display -->
            <div class="bg-white rounded-lg shadow-xl p-4 flex-grow flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Query Logs</h2>
                    <button id="toggleLogsBtn"
                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 text-sm">
                        Show Logs
                    </button>
                </div>
                <div id="queryLogsContainer" class="flex-grow relative">
                    <div id="queryLogsContent" class="query-logs-content absolute inset-0 bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm text-gray-800 overflow-y-auto font-mono">
                        <!-- Query logs will be loaded here -->
                        <p class="text-gray-500">Loading logs..</p>
                    </div>
                </div>
            </div>

        </aside>
    </main>

    <script>
        const queryForm = document.getElementById('queryForm');
        const queryInput = document.getElementById('queryInput');
        const chatMessages = document.getElementById('chatMessages');
        const totalQueriesSpan = document.getElementById('totalQueries');
        const lastQueryTimeSpan = document.getElementById('lastQueryTime');
        const toggleLogsBtn = document.getElementById('toggleLogsBtn');
        const queryLogsContainer = document.getElementById('queryLogsContainer');
        const queryLogsContent = document.getElementById('queryLogsContent');
        const toolUsageIndicator = document.getElementById('toolUsageIndicator');
        const currentToolName = document.getElementById('currentToolName');

        const API_AGENT_QUERY = '/api/answer-question'; // Renamed to match your backend
        const API_AGENT_STATS = '/api/agent-stats'; // You'll need to implement this endpoint on the backend

        // Function to scroll to the bottom of the chat
        function scrollToBottom(element) {
            element.scrollTop = element.scrollHeight;
        }

        // Add a message to the chat interface
        function addMessage(sender, text, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');

            const contentDiv = document.createElement('div');
            const baseClasses = ['p-3', 'rounded-lg', 'max-w-xs', 'md:max-w-md', 'shadow'];

            if (isError) {
                contentDiv.classList.add(...baseClasses, 'bg-red-100', 'text-red-800');
            } else {
                contentDiv.classList.add(
                    ...baseClasses,
                    sender === 'user' ? 'bg-indigo-500' : 'bg-blue-100',
                    sender === 'user' ? 'text-white' : 'text-blue-800'
                );
            }

            contentDiv.innerText = text;

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            scrollToBottom(chatMessages);
        }

        // Update statistics panel
        async function updateStats() {
            try {
                const response = await fetch(API_AGENT_STATS);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.success) {
                    totalQueriesSpan.innerText = data.totalQueries !== undefined ? data.totalQueries : 'N/A';
                    lastQueryTimeSpan.innerText = data.lastQueryTime ? new Date(data.lastQueryTime).toLocaleString() : 'N/A';

                    // Update query logs if container is visible
                    if (!queryLogsContainer.classList.contains('hidden') && data.queryLogs) {
                        renderQueryLogs(data.queryLogs);
                    }
                } else {
                    console.error('Failed to retrieve agent stats:', data.error);
                    // Handle error display
                }
            } catch (error) {
                console.error('Error fetching agent stats:', error);
                // Handle error display
            }
        }

        // Render query logs
        function renderQueryLogs(logs) {
            queryLogsContent.innerHTML = ''; // Clear previous logs
            if (logs.length === 0) {
                queryLogsContent.innerHTML = '<p class="text-gray-500">No logs available.</p>';
                return;
            }
            logs.forEach(log => {
                const logEntryDiv = document.createElement('div');
                logEntryDiv.classList.add('mb-4', 'p-2', 'bg-white', 'rounded-md', 'shadow-sm', 'border', 'border-gray-100');
                logEntryDiv.innerHTML = `
                    <p><strong>Time:</strong> ${new Date(log.timestamp).toLocaleString()}</p>
                    <p><strong>Query:</strong> ${log.query}</p>
                    <p><strong>Answer:</strong> ${log.answer}</p>
                    <p><strong>Duration:</strong> ${log.duration}ms</p>
                    <p><strong>Chunks:</strong> ${log.chunksRetrieved}</p>
                `;
                queryLogsContent.appendChild(logEntryDiv);
            });
            scrollToBottom(queryLogsContent);
        }

        // Event listener for query form submission
        queryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = queryInput.value.trim();
            if (!query) return;

            addMessage('user', query);
            queryInput.value = ''; // Clear input

            // Show tool usage indicator
            toolUsageIndicator.classList.remove('hidden');
            currentToolName.innerText = 'thinking'; // Default text

            try {
                const response = await fetch(API_AGENT_QUERY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: query }), // Ensure the body matches your server.js endpoint
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data); // Debugging

                // Hide tool usage indicator
                toolUsageIndicator.classList.add('hidden');

                if (data.success) {
                    addMessage('agent', data.answer || "I processed your request, but there's no direct answer available.");
                    // You might need to update the `currentToolName` based on `data.toolUsed` if your backend sends it
                    // currentToolName.innerText = data.toolUsed || 'completed';
                } else {
                    addMessage('agent', data.error || 'An unknown error occurred.', true);
                }
            } catch (error) {
                console.error('Error sending query:', error);
                toolUsageIndicator.classList.add('hidden'); // Hide on error
                addMessage('agent', 'Sorry, I am having trouble connecting to the agent. Please try again later.', true);
            } finally {
                updateStats(); // Always update stats after a query
            }
        });

        // Event listener for toggle logs button
        toggleLogsBtn.addEventListener('click', async () => {
            const isHidden = queryLogsContainer.classList.toggle('hidden');
            toggleLogsBtn.innerText = isHidden ? 'Show Logs' : 'Hide Logs';
            if (!isHidden) {
                // Fetch logs when shown
                try {
                    const response = await fetch(API_AGENT_STATS);
                    const data = await response.json();
                    if (data.success && data.queryLogs) {
                        renderQueryLogs(data.queryLogs);
                    } else {
                        queryLogsContent.innerHTML = '<p class="text-gray-500">Failed to load logs.</p>';
                    }
                } catch (error) {
                    console.error('Error fetching logs:', error);
                    queryLogsContent.innerHTML = '<p class="text-red-500">Error loading logs.</p>';
                }
            }
        });

        // Initial load of stats and logs
        updateStats();

        // Load logs initially since they're visible by default
        (async () => {
            try {
                const response = await fetch(API_AGENT_STATS);
                const data = await response.json();
                if (data.success && data.queryLogs) {
                    renderQueryLogs(data.queryLogs);
                } else {
                    queryLogsContent.innerHTML = '<p class="text-gray-500">No logs available.</p>';
                }
            } catch (error) {
                console.error('Error fetching initial logs:', error);
                queryLogsContent.innerHTML = '<p class="text-gray-500">No logs loaded yet.</p>';
            }
        })();

        // Periodically update stats (e.g., every 10 seconds)
        setInterval(updateStats, 10000); // Update every 10 seconds for real-time feel
    </script>
</body>
</html>